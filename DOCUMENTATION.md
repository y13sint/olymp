# Документация проекта «Управление столовой»

---

## Оглавление

| № | Раздел |
|---|--------|
| — | [Титульный лист](#титульный-лист) |
| 1 | [Обоснование выбора языка и программных средств](#1-обоснование-выбора-языка-программирования-и-программных-средств) |
| 2 | [Структурная и функциональная схемы](#2-структурная-и-функциональная-схемы-программного-продукта) |
| 3 | [Блок-схема работы основного алгоритма](#3-блок-схема-работы-основного-алгоритма) |
| 4 | [Описание и аргументация выбора СУБД](#4-описание-особенностей-и-аргументация-выбранного-типа-субд) |
| 5 | [Схема базы данных](#5-схема-базы-данных) |
| 6 | [Статистика проекта](#6-статистика-проекта) |
| 7 | [Тестовые пользователи](#7-тестовые-пользователи) |
| 8 | [Ссылки (репозиторий, видео)](#8-ссылки) |

**Файл README.md** — см. отдельный файл (краткое описание, инструкция, ссылка на видео)

---

## Титульный лист

**МОСКОВСКАЯ ПРЕДПРОФЕССИОНАЛЬНАЯ ОЛИМПИАДА ШКОЛЬНИКОВ**

**Профиль «Информационные технологии»**

---

### Командный кейс № 2

# «Управление столовой»

### Автоматизированная информационная система школьного питания

---

**Команда:** `322`

**Участники:**

1. `Шморгун Никита Андреевич`
2. `Ашитков Антон Игоревич`
3. `Жунь Сергей Ильич`
4. `Кадырова Беата Рашидовна`
5. `Малиновская Виктория Владимировна`

**Школа:** `1558`

**Руководитель:** `Гончаров Алексей Дмитриевич`

**Год:** 2026

## 1. Обоснование выбора языка программирования и программных средств

### 1.1. Клиентская часть (Frontend)

| Технология | Версия | Обоснование выбора |
|------------|--------|-------------------|
| **JavaScript (ES6+)** | — | Стандарт веб-разработки, поддерживается всеми браузерами, большое сообщество |
| **React** | 18.2.0 | Компонентный подход, виртуальный DOM для производительности, богатая экосистема |
| **Vite** | 5.1.0 | Мгновенная перезагрузка при разработке (HMR), быстрая сборка через esbuild |
| **React Router** | 6.22.0 | Декларативный роутинг, защита маршрутов по ролям |
| **Ant Design** | 5.14.0 | Готовые UI-компоненты (таблицы, формы, модалки), доступность (a11y) |
| **TanStack Query** | 5.17.0 | Кэширование данных, автоматические повторные запросы, оптимистичные обновления |
| **Zustand** | 4.5.0 | Легковесный state manager (~1KB), простой API, persist для localStorage |
| **Axios** | 1.6.7 | Interceptors для JWT refresh, обработка ошибок, timeout |
| **Day.js** | 1.11.10 | Работа с датами (~2KB vs 70KB Moment.js), поддержка isoWeek |

**Почему React, а не Vue/Angular:**

- Большее сообщество и количество готовых решений
- Функциональные компоненты с хуками — чище код
- Лучшая интеграция с TypeScript (при необходимости)

### 1.2. Серверная часть (Backend)

| Технология | Версия | Обоснование выбора |
|------------|--------|-------------------|
| **Node.js** | 18+ | Единый язык (JS) для frontend и backend, асинхронная модель |
| **Express** | 4.18.2 | Минималистичный фреймворк, большая экосистема middleware |
| **Sequelize** | 6.36.0 | ORM с поддержкой миграций, валидации, связей между таблицами |
| **PostgreSQL** | 15+ | ACID-транзакции, JSON-поддержка, надёжность (см. раздел 5) |
| **JWT** | 9.0.2 | Stateless аутентификация, поддержка refresh токенов |
| **bcryptjs** | 2.4.3 | Хеширование паролей с salt, защита от rainbow tables |
| **Joi** | 17.12.1 | Декларативная валидация запросов, понятные сообщения об ошибках |
| **Helmet** | 8.1.0 | Security headers (CSP, HSTS, X-Frame-Options) |
| **Pino** | 10.3.0 | Высокопроизводительный JSON-логгер, структурированные логи |

**Почему Express, а не Fastify/Nest.js:**

- Простота и предсказуемость
- Огромное количество готовых middleware
- Достаточно для задач олимпиады без оверхеда фреймворков

### 1.3. Инфраструктура

| Технология | Обоснование |
|------------|-------------|
| **Docker** | Изолированная среда, воспроизводимость на любой машине |
| **Docker Compose** | Оркестрация контейнеров (app + db) одной командой |
| **Git** | Контроль версий, история изменений, командная работа |
| **ESLint** | Единый стиль кода, обнаружение ошибок до запуска |

### 1.4. Архитектурные решения

**Frontend — Feature-Sliced Design (FSD):**

```
client/src/
├── app/          # Providers, роутер, инициализация
├── pages/        # Страницы (по ролям: student, cook, admin)
├── widgets/      # Крупные компоненты (layouts)
├── features/     # Бизнес-функции (auth)
└── shared/       # Переиспользуемый код (api, ui, hooks)
```

**Backend — Layer Architecture:**

```
server/src/
├── interface/http/      # Controllers, Routes, Validators
├── shared/services/     # Бизнес-логика
├── shared/errors/       # Обработка ошибок
└── infrastructure/      # Database models, migrations
```

**Почему не DDD:**
> DDD избыточен для данного проекта. Он оправдан для систем со сложной бизнес-логикой (банки, страховки, ERP). Для школьной столовой с ~70 CRUD-эндпоинтами слоистая архитектура обеспечивает достаточное разделение ответственности без лишнего оверхеда.

---

## 2. Структурная и функциональная схемы программного продукта

### 2.1. Структурная схема (Архитектура системы)

```
┌─────────────────────────────────────────────────────────────────────────┐
│                              КЛИЕНТ                                      │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │                    React SPA (Vite)                              │    │
│  │  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────────────┐ │    │
│  │  │  Ученик   │ │   Повар   │ │   Админ   │ │   Общие модули    │ │    │
│  │  │  (5 стр.) │ │  (4 стр.) │ │  (8 стр.) │ │  (auth, layout)   │ │    │
│  │  └─────┬─────┘ └─────┬─────┘ └─────┬─────┘ └─────────┬─────────┘ │    │
│  │        │             │             │                 │           │    │
│  │        └─────────────┴─────────────┴─────────────────┘           │    │
│  │                              │                                    │    │
│  │                    ┌─────────┴─────────┐                         │    │
│  │                    │   Zustand Store   │                         │    │
│  │                    │   React Query     │                         │    │
│  │                    └─────────┬─────────┘                         │    │
│  │                              │                                    │    │
│  │                    ┌─────────┴─────────┐                         │    │
│  │                    │    Axios API      │                         │    │
│  │                    │   (interceptors)  │                         │    │
│  │                    └─────────┬─────────┘                         │    │
│  └──────────────────────────────┼──────────────────────────────────┘    │
└─────────────────────────────────┼───────────────────────────────────────┘
                                  │ HTTPS / REST API
                                  ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                              СЕРВЕР                                      │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │                    Express.js Application                        │    │
│  │  ┌─────────────────────────────────────────────────────────────┐ │    │
│  │  │                     Middleware Layer                         │ │    │
│  │  │  ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐ ┌────────────┐ │ │    │
│  │  │  │ CORS   │ │ Helmet │ │ Rate   │ │ CSRF   │ │ JWT Auth   │ │ │    │
│  │  │  │        │ │        │ │ Limit  │ │        │ │            │ │ │    │
│  │  │  └────────┘ └────────┘ └────────┘ └────────┘ └────────────┘ │ │    │
│  │  └─────────────────────────────────────────────────────────────┘ │    │
│  │  ┌─────────────────────────────────────────────────────────────┐ │    │
│  │  │                     Interface Layer                          │ │    │
│  │  │  ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐ │ │    │
│  │  │  │   Auth     │ │  Student   │ │    Cook    │ │   Admin    │ │ │    │
│  │  │  │ Controller │ │ Controller │ │ Controller │ │ Controller │ │ │    │
│  │  │  └─────┬──────┘ └─────┬──────┘ └─────┬──────┘ └─────┬──────┘ │ │    │
│  │  │        │              │              │              │        │ │    │
│  │  │        └──────────────┴──────────────┴──────────────┘        │ │    │
│  │  └────────────────────────────────┬────────────────────────────┘ │    │
│  │  ┌────────────────────────────────┴────────────────────────────┐ │    │
│  │  │                      Service Layer                           │ │    │
│  │  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────────────┐ │ │    │
│  │  │  │ Payment  │ │   Meal   │ │Inventory │ │   Notification   │ │ │    │
│  │  │  │ Service  │ │ Service  │ │ Service  │ │     Service      │ │ │    │
│  │  │  └──────────┘ └──────────┘ └──────────┘ └──────────────────┘ │ │    │
│  │  └────────────────────────────────┬────────────────────────────┘ │    │
│  │  ┌────────────────────────────────┴────────────────────────────┐ │    │
│  │  │                   Infrastructure Layer                       │ │    │
│  │  │  ┌──────────────────────────────────────────────────────┐   │ │    │
│  │  │  │              Sequelize ORM (21 модель)                 │   │ │    │
│  │  │  └────────────────────────┬─────────────────────────────┘   │ │    │
│  │  └───────────────────────────┼─────────────────────────────────┘ │    │
│  └──────────────────────────────┼──────────────────────────────────┘    │
└─────────────────────────────────┼───────────────────────────────────────┘
                                  │ TCP/5432
                                  ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                          БАЗА ДАННЫХ                                     │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │                    PostgreSQL 15+                                │    │
│  │  ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────────┐ │    │
│  │  │   users    │ │   menu_*   │ │ payments   │ │ notifications  │ │    │
│  │  │ allergies  │ │ meal_*     │ │subscriptions│ │ products      │ │    │
│  │  │ reviews    │ │ templates  │ │ inventory  │ │ requests      │ │    │
│  │  └────────────┘ └────────────┘ └────────────┘ └────────────────┘ │    │
│  └─────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────┘
```

### 2.2. Функциональная схема (Use Case Diagram)

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      СИСТЕМА УПРАВЛЕНИЯ СТОЛОВОЙ                         │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌──────────────┐                                                        │
│  │   УЧЕНИК     │                                                        │
│  │  (Student)   │───┬──► Регистрация и авторизация                       │
│  └──────────────┘   │                                                    │
│                     ├──► Просмотр меню на неделю                         │
│                     │    └──► Навигация по неделям                       │
│                     │    └──► Подсветка аллергенов                       │
│                     │                                                    │
│                     ├──► Оплата питания                                  │
│                     │    ├──► Разовый платёж (пополнение)                │
│                     │    └──► Покупка абонемента                         │
│                     │                                                    │
│                     ├──► Заказ и получение питания                       │
│                     │    └──► Проверка баланса/подписки                  │
│                     │                                                    │
│                     ├──► Мои заказы (подтверждение получения)            │
│                     │    └──► Отметка о получении питания                │
│                     │                                                    │
│                     ├──► Управление профилем                             │
│                     │    ├──► Указание аллергий                          │
│                     │    ├──► Указание пищевых предпочтений              │
│                     │    └──► Смена пароля                               │
│                     │                                                    │
│                     ├──► Отзывы о блюдах                                 │
│                     │    ├──► Просмотр отзывов на блюдо (в меню)         │
│                     │    ├──► Оставить отзыв и оценку                    │
│                     │    └──► Удалить свой отзыв                         │
│                     │                                                    │
│                     └──► Визуальные подсказки в меню                     │
│                          ├──► Подсветка аллергенов (красный)             │
│                          └──► Подсветка предпочтений (зелёный)           │
│                                                                          │
│  ┌──────────────┐                                                        │
│  │    ПОВАР     │                                                        │
│  │    (Cook)    │───┬──► Авторизация                                     │
│  └──────────────┘   │                                                    │
│                     ├──► Учёт выдачи питания                             │
│                     │    └──► Просмотр статусов выдач (только чтение)    │
│                     │                                                    │
│                     ├──► Управление продуктами (CRUD)                    │
│                     │    ├──► Создание продуктов (кг, л, шт...)          │
│                     │    ├──► Редактирование продуктов                   │
│                     │    └──► Удаление (с проверкой рецептур)            │
│                     │                                                    │
│                     ├──► Контроль остатков продуктов                     │
│                     │    ├──► Списание                                   │
│                     │    └──► Приход                                     │
│                     │                                                    │
│                     ├──► Управление рецептурой блюд                      │
│                     │    ├──► Просмотр ингредиентов блюда                │
│                     │    └──► Настройка ингредиентов (продукт + кол-во)  │
│                     │                                                    │
│                     └──► Заявки на закупку                               │
│                          ├──► Создание/удаление                          │
│                          └──► Создание при добавлении продукта           │
│                                                                          │
│  ┌──────────────┐                                                        │
│  │ АДМИНИСТРАТОР│                                                        │
│  │   (Admin)    │───┬──► Авторизация                                     │
│  └──────────────┘   │                                                    │
│                     ├──► Статистика и дашборд                            │
│                     │    ├──► Статистика оплат                           │
│                     │    └──► Статистика посещаемости                    │
│                     │                                                    │
│                     ├──► Согласование заявок на закупку                  │
│                     │    ├──► Одобрение (→ пополнение склада)            │
│                     │    └──► Отклонение (→ уведомление повару)          │
│                     │                                                    │
│                     ├──► Формирование отчётов                            │
│                     │    ├──► Отчёт по питанию                           │
│                     │    ├──► Отчёт по затратам                          │
│                     │    └──► Экспорт в CSV                              │
│                     │                                                    │
│                     ├──► Управление меню                                 │
│                     │    ├──► Создание дней меню                         │
│                     │    ├──► Добавление блюд                            │
│                     │    └──► Применение шаблонов                        │
│                     │                                                    │
│                     ├──► Управление пользователями                       │
│                     │    ├──► CRUD операции                              │
│                     │    └──► Soft delete / Восстановление               │
│                     │                                                    │
│                     ├──► Система шаблонов меню                           │
│                     │    ├──► Шаблоны дней                               │
│                     │    ├──► Группы (shuffle)                           │
│                     │    └──► Недельные шаблоны                          │
│                     │                                                    │
│                     └──► Рассылка уведомлений                            │
│                          ├──► Всем пользователям                         │
│                          └──► По роли (ученики/повара/админы)            │
│                                                                          │
│  ┌──────────────┐                                                        │
│  │  СИСТЕМА     │───┬──► Автоматические уведомления                      │
│  │ (Background) │   │    ├──► При низком остатке продуктов               │
│  └──────────────┘   │    ├──► При согласовании заявки                    │
│                     │    └──► При отклонении заявки                      │
│                     │                                                    │
│                     ├──► Автоматическое списание ингредиентов            │
│                     │    ├──► При выдаче блюда → списание по рецептуре   │
│                     │    ├──► Проверка достаточности продуктов           │
│                     │    └──► Авто-отключение блюд при нехватке          │
│                     │                                                    │
│                     └──► Автоочистка токенов (каждый час)                │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 2.3. Схема взаимодействия модулей

```
┌─────────────────────────────────────────────────────────────────┐
│                        FRONTEND MODULES                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  pages/student/          pages/cook/          pages/admin/       │
│  ┌──────────────┐       ┌──────────────┐     ┌──────────────┐   │
│  │ MenuPage     │       │ MealsPage    │     │ DashboardPage│   │
│  │ PaymentsPage │       │ InventoryPage│     │ RequestsPage │   │
│  │ ProfilePage  │       │ RequestsPage │     │ ReportsPage  │   │
│  │ ReviewsPage  │       │ RecipesPage  │     │ MenuPage     │   │
│  │ OrdersPage   │       └──────────────┘     │ UsersPage    │   │
│  └──────────────┘                            │ TemplatesPage│   │
│                                              └──────────────┘   │
│         │                      │                    │           │
│         └──────────────────────┴────────────────────┘           │
│                                │                                 │
│                    ┌───────────┴───────────┐                    │
│                    │     shared/api/       │                    │
│                    │ ┌─────────────────┐   │                    │
│                    │ │ student.api.js  │   │                    │
│                    │ │ cook.api.js     │   │                    │
│                    │ │ admin.api.js    │   │                    │
│                    │ │ menu.api.js     │   │                    │
│                    │ │ notification.api│   │                    │
│                    │ │ template.api.js │   │                    │
│                    │ └─────────────────┘   │                    │
│                    └───────────┬───────────┘                    │
│                                │                                 │
└────────────────────────────────┼────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────┐
│                        BACKEND MODULES                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  interface/http/controllers/                                     │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────────────────┐ │
│  │ auth         │ │ student      │ │ cook                     │ │
│  │ controller   │ │ controller   │ │ controller               │ │
│  └──────┬───────┘ └──────┬───────┘ └──────────┬───────────────┘ │
│         │                │                     │                 │
│  ┌──────┴───────┐ ┌──────┴───────┐ ┌──────────┴───────────────┐ │
│  │ admin        │ │ menu         │ │ notification             │ │
│  │ controller   │ │ controller   │ │ controller               │ │
│  └──────┬───────┘ └──────┬───────┘ └──────────┬───────────────┘ │
│         │                │                     │                 │
│         └────────────────┴─────────────────────┘                 │
│                          │                                       │
│              ┌───────────┴───────────┐                          │
│              │   shared/services/    │                          │
│              │ ┌─────────────────┐   │                          │
│              │ │ jwt.service     │   │                          │
│              │ │ password.service│   │                          │
│              │ │ payment.service │   │                          │
│              │ │ meal.service    │   │                          │
│              │ │ inventory.service│  │                          │
│              │ │ notification.svc│   │                          │
│              │ │ template.service│   │                          │
│              │ └─────────────────┘   │                          │
│              └───────────┬───────────┘                          │
│                          │                                       │
│              ┌───────────┴───────────┐                          │
│              │infrastructure/database│                          │
│              │     /models/          │                          │
│              │ ┌─────────────────┐   │                          │
│              │ │ User, Payment   │   │                          │
│              │ │ Subscription    │   │                          │
│              │ │ MenuDay, Item   │   │                          │
│              │ │ MealPickup      │   │                          │
│              │ │ Product,Inventory│  │                          │
│              │ │ PurchaseRequest │   │                          │
│              │ │ Review, Allergy │   │                          │
│              │ │ Notification    │   │                          │
│              │ │ RefreshToken    │   │                          │
│              │ │ FoodPreference  │   │                          │
│              │ │ Templates (7)   │   │                          │
│              │ └─────────────────┘   │                          │
│              └───────────────────────┘                          │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 3. Блок-схема работы основного алгоритма

### 3.1. Алгоритм заказа питания учеником

```
                              ┌─────────────────┐
                              │     НАЧАЛО      │
                              └────────┬────────┘
                                       │
                              ┌────────▼────────┐
                              │ Ученик выбирает │
                              │  блюдо в меню   │
                              └────────┬────────┘
                                       │
                              ┌────────▼────────┐
                              │ Нажимает кнопку │
                              │    "Заказать"   │
                              └────────┬────────┘
                                       │
                    ┌──────────────────▼──────────────────┐
                    │     API: POST /api/student/meals    │
                    │             /pickup                 │
                    └──────────────────┬──────────────────┘
                                       │
                    ┌──────────────────▼──────────────────┐
                    │      Проверка JWT авторизации       │
                    └──────────────────┬──────────────────┘
                                       │
                         ┌─────────────▼─────────────┐
                         │   JWT валиден?            │
                         └─────────────┬─────────────┘
                                       │
                      ┌────────NO──────┴──────YES────────┐
                      │                                   │
             ┌────────▼────────┐              ┌──────────▼──────────┐
             │ Ошибка 401:     │              │ Начало транзакции   │
             │ Unauthorized    │              └──────────┬──────────┘
             └─────────────────┘                         │
                                             ┌──────────▼──────────┐
                                             │ Проверка блюда:     │
                                             │ - из сегодняшнего   │
                                             │   меню?             │
                                             │ - isAvailable?      │
                                             └──────────┬──────────┘
                                                        │
                                           ┌────────────▼────────────┐
                                           │  Блюдо доступно?        │
                                           └────────────┬────────────┘
                                                        │
                                       ┌────────NO──────┴──────YES────────┐
                                       │                                   │
                              ┌────────▼────────┐              ┌──────────▼──────────┐
                              │ Ошибка 400:     │              │ Проверка: уже       │
                              │ "Блюдо временно │              │ заказывал этот тип  │
                              │  недоступно"    │              │ питания сегодня?    │
                              └─────────────────┘              └──────────┬──────────┘
                                                                         │
                                                          ┌──────────────▼──────────────┐
                                                          │   Уже заказывал?            │
                                                          └──────────────┬──────────────┘
                                                                         │
                                                        ┌────────YES─────┴─────NO──────┐
                                                        │                               │
                                               ┌────────▼────────┐          ┌──────────▼──────────┐
                                               │ Ошибка 409:     │          │ Загрузка рецептуры: │
                                               │ "Уже получили   │          │ MenuItemIngredient  │
                                               │  сегодня"       │          │ + SELECT FOR UPDATE │
                                               └─────────────────┘          │ на Products         │
                                                                            └──────────┬──────────┘
                                                                                       │
                                                                            ┌──────────▼──────────┐
                                                                            │ Проверка каждого    │
                                                                            │ ингредиента:        │
                                                                            │ product.quantity >= │
                                                                            │ ingredient.quantity │
                                                                            └──────────┬──────────┘
                                                                                       │
                                                                         ┌─────────────▼─────────────┐
                                                                         │  Все ингредиенты есть?   │
                                                                         └─────────────┬─────────────┘
                                                                                       │
                                                                      ┌────────NO──────┴──────YES────────┐
                                                                      │                                   │
                                                             ┌────────▼────────┐              ┌──────────▼──────────┐
                                                             │ Ошибка 400:     │              │ SELECT FOR UPDATE   │
                                                             │ "Недостаточно   │              │ на User             │
                                                             │  ингредиента:   │              │ (блокировка)        │
                                                             │  {название}"    │              └──────────┬──────────┘
                                                             └─────────────────┘                         │
                                                                                              ┌──────────▼──────────┐
                                                                                              │ Проверка активной   │
                                                                                              │ подписки            │
                                                                                              └──────────┬──────────┘
                                                                                                         │
                                                                                           ┌─────────────▼─────────────┐
                                                                                           │   Есть подписка на       │
                                                                                           │   этот тип питания?      │
                                                                                           └─────────────┬─────────────┘
                                                                                                         │
                                                                                           ┌─────YES─────┴─────NO──────┐
                                                                                           │                           │
                                                                                 ┌─────────▼─────────┐    ┌────────────▼────────────┐
                                                                                 │ paidBy =          │    │  Проверка баланса       │
                                                                                 │ 'subscription'    │    │  >= цена блюда          │
                                                                                 └─────────┬─────────┘    └────────────┬────────────┘
                                                                                           │               ┌───────────▼───────────┐
                                                                                           │               │  Баланс достаточен?   │
                                                                                           │               └───────────┬───────────┘
                                                                                           │                           │
                                                                                           │              ┌─────NO─────┴────YES────┐
                                                                                           │              │                        │
                                                                                           │    ┌─────────▼─────────┐  ┌───────────▼───────────┐
                                                                                           │    │ Ошибка 400:       │  │ user.decrement(price) │
                                                                                           │    │ "Недостаточно     │  │ paidBy = 'balance'    │
                                                                                           │    │  средств"         │  └───────────┬───────────┘
                                                                                           │    └─────────────────┘              │
                                                                                           │                                     │
                                                                                           └─────────────────┬───────────────────┘
                                                                                                             │
                                                                                              ┌──────────────▼──────────────┐
                                                                                              │  СПИСАНИЕ ИНГРЕДИЕНТОВ:     │
                                                                                              │  for each ingredient:       │
                                                                                              │  - Product.decrement()      │
                                                                                              │  - Inventory.create()       │
                                                                                              └──────────────┬──────────────┘
                                                                                                             │
                                                                                              ┌──────────────▼──────────────┐
                                                                                              │  Создать MealPickup         │
                                                                                              └──────────────┬──────────────┘
                                                                                                             │
                                                                                              ┌──────────────▼──────────────┐
                                                                                              │  ПРОВЕРКА ОСТАТКОВ:         │
                                                                                              │  for each ingredient:       │
                                                                                              │  if quantity < minQuantity  │
                                                                                              └──────────────┬──────────────┘
                                                                                                             │
                                                                                               ┌─────────────▼─────────────┐
                                                                                               │  Остаток ниже минимума?   │
                                                                                               └─────────────┬─────────────┘
                                                                                                             │
                                                                                            ┌────────YES─────┴─────NO──────┐
                                                                                            │                               │
                                                                                 ┌──────────▼──────────┐                   │
                                                                                 │ АВТО-ОТКЛЮЧЕНИЕ:    │                   │
                                                                                 │ - MenuItem.update   │                   │
                                                                                 │   isAvailable=false │                   │
                                                                                 │ - Уведомление       │                   │
                                                                                 │   всем поварам      │                   │
                                                                                 └──────────┬──────────┘                   │
                                                                                            │                               │
                                                                                            └───────────────┬───────────────┘
                                                                                                            │
                                                                                              ┌─────────────▼─────────────┐
                                                                                              │       COMMIT транзакции   │
                                                                                              └─────────────┬─────────────┘
                                                                                                            │
                                                                                              ┌─────────────▼─────────────┐
                                                                                              │   Ответ 201: { pickup,    │
                                                                                              │              paidBy }     │
                                                                                              └─────────────┬─────────────┘
                                                                                                            │
                                                                                              ┌─────────────▼─────────────┐
                                                                                              │          КОНЕЦ            │
                                                                                              └───────────────────────────┘
```

### 3.2. Алгоритм подтверждения получения питания учеником

```
                              ┌─────────────────┐
                              │     НАЧАЛО      │
                              └────────┬────────┘
                                       │
                              ┌────────▼────────┐
                              │ Ученик открывает│
                              │ "Мои заказы"    │
                              └────────┬────────┘
                                       │
                    ┌──────────────────▼──────────────────┐
                    │   API: GET /api/student/meals       │
                    └──────────────────┬──────────────────┘
                                       │
                              ┌────────▼────────┐
                              │ Отображение     │
                              │ списка заказов  │
                              │ на сегодня      │
                              └────────┬────────┘
                                       │
                              ┌────────▼────────┐
                              │ Ученик нажимает │
                              │ "Подтвердить    │
                              │  получение"     │
                              └────────┬────────┘
                                       │
                    ┌──────────────────▼──────────────────┐
                    │  API: POST /api/student/meals/      │
                    │        :id/confirm                  │
                    └──────────────────┬──────────────────┘
                                       │
                    ┌──────────────────▼──────────────────┐
                    │      Проверка JWT авторизации       │
                    └──────────────────┬──────────────────┘
                                       │
                         ┌─────────────▼─────────────┐
                         │   JWT валиден?            │
                         └─────────────┬─────────────┘
                                       │
                      ┌────────NO──────┴──────YES────────┐
                      │                                   │
             ┌────────▼────────┐              ┌──────────▼──────────┐
             │ Ошибка 401:     │              │ MealPickup.findOne  │
             │ Unauthorized    │              │ { id, userId }      │
             └─────────────────┘              └──────────┬──────────┘
                                                        │
                                             ┌──────────▼──────────┐
                                             │  Заказ найден и     │
                                             │  принадлежит юзеру? │
                                             └──────────┬──────────┘
                                                        │
                                       ┌────────NO──────┴──────YES────────┐
                                       │                                   │
                              ┌────────▼────────┐              ┌──────────▼──────────┐
                              │ Ошибка 404:     │              │ pickup.isReceived   │
                              │ "Заказ не найден│              │ уже true?           │
                              └─────────────────┘              └──────────┬──────────┘
                                                                         │
                                                        ┌────────YES─────┴─────NO──────┐
                                                        │                               │
                                               ┌────────▼────────┐          ┌──────────▼──────────┐
                                               │ Ошибка 409:     │          │ pickupDate ==       │
                                               │ "Уже отмечено"  │          │ сегодня?            │
                                               └─────────────────┘          └──────────┬──────────┘
                                                                                       │
                                                                      ┌────────NO──────┴──────YES────────┐
                                                                      │                                   │
                                                             ┌────────▼────────┐              ┌──────────▼──────────┐
                                                             │ Ошибка 400:     │              │ pickup.isReceived   │
                                                             │ "Можно отметить │              │   = true            │
                                                             │ только сегодня" │              │ pickup.receivedAt   │
                                                             └─────────────────┘              │   = new Date()      │
                                                                                              │ pickup.save()       │
                                                                                              └──────────┬──────────┘
                                                                                                         │
                                                                                              ┌──────────▼──────────┐
                                                                                              │ Ответ 200:          │
                                                                                              │ { message, pickup } │
                                                                                              └──────────┬──────────┘
                                                                                                         │
                                                                                              ┌──────────▼──────────┐
                                                                                              │      КОНЕЦ          │
                                                                                              └─────────────────────┘
```

### 3.3. Алгоритм авторизации с JWT

```
                              ┌─────────────────┐
                              │     НАЧАЛО      │
                              └────────┬────────┘
                                       │
                              ┌────────▼────────┐
                              │ Пользователь    │
                              │ вводит логин и  │
                              │ пароль          │
                              └────────┬────────┘
                                       │
                    ┌──────────────────▼──────────────────┐
                    │     API: POST /api/auth/login       │
                    └──────────────────┬──────────────────┘
                                       │
                    ┌──────────────────▼──────────────────┐
                    │     Joi валидация email/password    │
                    └──────────────────┬──────────────────┘
                                       │
                         ┌─────────────▼─────────────┐
                         │   Валидация прошла?       │
                         └─────────────┬─────────────┘
                                       │
                      ┌────────NO──────┴──────YES────────┐
                      │                                   │
             ┌────────▼────────┐              ┌──────────▼──────────┐
             │ Ошибка 400:     │              │ User.findOne({email})│
             │ Validation Error│              └──────────┬──────────┘
             └─────────────────┘                         │
                                             ┌───────────▼───────────┐
                                             │   Пользователь найден?│
                                             └───────────┬───────────┘
                                                         │
                                        ┌────────NO──────┴──────YES────────┐
                                        │                                   │
                               ┌────────▼────────┐              ┌──────────▼──────────┐
                               │ Ошибка 401:     │              │ bcrypt.compare      │
                               │ Invalid creds   │              │ (password, hash)    │
                               └─────────────────┘              └──────────┬──────────┘
                                                                           │
                                                               ┌───────────▼───────────┐
                                                               │  Пароль верный?       │
                                                               └───────────┬───────────┘
                                                                           │
                                                          ┌────────NO──────┴──────YES────────┐
                                                          │                                   │
                                                 ┌────────▼────────┐              ┌──────────▼──────────┐
                                                 │ Ошибка 401:     │              │ enforceSessionLimit │
                                                 │ Invalid creds   │              │ (макс 5 сессий)     │
                                                 └─────────────────┘              └──────────┬──────────┘
                                                                                             │
                                                                                  ┌──────────▼──────────┐
                                                                                  │ Генерация токенов:  │
                                                                                  │ - accessToken (15m) │
                                                                                  │ - refreshToken (7d) │
                                                                                  └──────────┬──────────┘
                                                                                             │
                                                                                  ┌──────────▼──────────┐
                                                                                  │ Сохранение refresh  │
                                                                                  │ токена в БД         │
                                                                                  └──────────┬──────────┘
                                                                                             │
                                                                                  ┌──────────▼──────────┐
                                                                                  │ Установка cookies:  │
                                                                                  │ - refreshToken      │
                                                                                  │   (httpOnly)        │
                                                                                  │ - XSRF-TOKEN        │
                                                                                  │   (CSRF защита)     │
                                                                                  └──────────┬──────────┘
                                                                                             │
                                                                                  ┌──────────▼──────────┐
                                                                                  │ Ответ 200:          │
                                                                                  │ { user, accessToken}│
                                                                                  └──────────┬──────────┘
                                                                                             │
                                                                                  ┌──────────▼──────────┐
                                                                                  │      КОНЕЦ          │
                                                                                  └─────────────────────┘
```

### 3.4. Алгоритм согласования заявки администратором

```
                              ┌─────────────────┐
                              │     НАЧАЛО      │
                              └────────┬────────┘
                                       │
                              ┌────────▼────────┐
                              │ Админ выбирает  │
                              │ заявку и статус │
                              │(approved/rejected)│
                              └────────┬────────┘
                                       │
                    ┌──────────────────▼──────────────────┐
                    │  API: PUT /api/admin/purchase-      │
                    │        requests/:id                 │
                    └──────────────────┬──────────────────┘
                                       │
                    ┌──────────────────▼──────────────────┐
                    │      Начало транзакции              │
                    └──────────────────┬──────────────────┘
                                       │
                    ┌──────────────────▼──────────────────┐
                    │ PurchaseRequest.findByPk(id)        │
                    │ + include: Product                  │
                    └──────────────────┬──────────────────┘
                                       │
                         ┌─────────────▼─────────────┐
                         │   Заявка найдена?         │
                         └─────────────┬─────────────┘
                                       │
                      ┌────────NO──────┴──────YES────────┐
                      │                                   │
             ┌────────▼────────┐              ┌──────────▼──────────┐
             │ Ошибка 404:     │              │ Проверка:           │
             │ "Заявка не      │              │ status == 'pending'?│
             │  найдена"       │              └──────────┬──────────┘
             └─────────────────┘                         │
                                          ┌─────────────▼─────────────┐
                                          │   Статус = pending?       │
                                          └─────────────┬─────────────┘
                                                        │
                                       ┌────────NO──────┴──────YES────────┐
                                       │                                   │
                              ┌────────▼────────┐              ┌──────────▼──────────┐
                              │ Ошибка 400:     │              │ request.status =    │
                              │ "Заявка уже     │              │   status            │
                              │  обработана"    │              │ request.approvedBy =│
                              └─────────────────┘              │   adminId           │
                                                               │ request.save()      │
                                                               └──────────┬──────────┘
                                                                          │
                                                            ┌─────────────▼─────────────┐
                                                            │   Статус = 'approved'?    │
                                                            └─────────────┬─────────────┘
                                                                          │
                                                         ┌────────YES─────┴─────NO──────┐
                                                         │                               │
                                              ┌──────────▼──────────┐                   │
                                              │ restockFromRequest  │                   │
                                              │ (productId,quantity,│                   │
                                              │  requestId,         │                   │
                                              │  transaction)       │                   │
                                              │ → пополнение склада │                   │
                                              └──────────┬──────────┘                   │
                                                         │                               │
                                                         └───────────────┬───────────────┘
                                                                         │
                                                          ┌──────────────▼──────────────┐
                                                          │       COMMIT транзакции     │
                                                          └──────────────┬──────────────┘
                                                                         │
                                                          ┌──────────────▼──────────────┐
                                                          │ notifyPurchaseRequest-      │
                                                          │ Decision (createdBy,        │
                                                          │ productName, qty, unit,     │
                                                          │ approved)                   │
                                                          │ → уведомление повару        │
                                                          └──────────────┬──────────────┘
                                                                         │
                                                          ┌──────────────▼──────────────┐
                                                          │   Ответ 200: { message,     │
                                                          │              request }      │
                                                          └──────────────┬──────────────┘
                                                                         │
                                                          ┌──────────────▼──────────────┐
                                                          │          КОНЕЦ              │
                                                          └─────────────────────────────┘
```

---

## 4. Описание особенностей и аргументация выбранного типа СУБД

### 4.1. Выбор СУБД: PostgreSQL

Для проекта выбрана реляционная СУБД **PostgreSQL версии 15+**.

### 4.2. Обоснование выбора

| Критерий | PostgreSQL | MySQL | SQLite | MongoDB |
|----------|------------|-------|--------|---------|
| **ACID-транзакции** | ✅ Полная поддержка | ✅ С InnoDB | ⚠️ Ограничено | ❌ Нет |
| **Финансовые операции** | ✅ DECIMAL, FOR UPDATE | ✅ DECIMAL | ⚠️ Нет блокировок | ❌ Не рекомендуется |
| **Сложные запросы** | ✅ CTE, оконные функции | ⚠️ Ограничено | ⚠️ Ограничено | ❌ Агрегации сложнее |
| **JSON поддержка** | ✅ JSONB с индексами | ✅ JSON | ⚠️ Строки | ✅ Нативно |
| **Open Source** | ✅ Бесплатно | ✅ Бесплатно | ✅ Бесплатно | ⚠️ Ограничения |
| **Масштабируемость** | ✅ Репликация, шардинг | ✅ Репликация | ❌ Single file | ✅ Горизонтальное |

### 4.3. Почему PostgreSQL, а не другие СУБД

**1. Финансовые операции требуют ACID:**

Система обрабатывает платежи и баланс учеников. Нужны:

- **Atomicity** — списание средств + создание заказа = одна транзакция
- **Consistency** — баланс не может быть отрицательным
- **Isolation** — SELECT FOR UPDATE предотвращает race condition
- **Durability** — данные не теряются при сбое

```sql
-- Пример транзакции с блокировкой
BEGIN;
SELECT * FROM users WHERE id = 1 FOR UPDATE;
UPDATE users SET balance = balance - 100 WHERE id = 1;
INSERT INTO meal_pickups (...) VALUES (...);
COMMIT;
```

**2. Реляционная модель подходит для структурированных данных:**

- Пользователи, платежи, заказы — чёткая структура
- Связи между таблицами (FK) обеспечивают целостность
- Нормализация исключает дублирование данных

**3. PostgreSQL vs MySQL:**

- Лучшая поддержка ENUM типов (роли, статусы)
- Более строгий SQL-стандарт
- Лучшая производительность на сложных запросах (отчёты)
- Встроенная поддержка paranoid (soft delete) через timestamp

**4. Почему не MongoDB:**

- Финансовые данные не подходят для документной модели
- Нет транзакций между документами (до v4.0)
- Сложнее обеспечить консистентность связей

### 4.4. Используемые возможности PostgreSQL

| Возможность | Применение в проекте |
|-------------|---------------------|
| **ENUM типы** | `role` (student, cook, admin), `status` (pending, approved, rejected) |
| **DECIMAL(10,2)** | Баланс, цены блюд, суммы платежей |
| **SERIAL / BIGSERIAL** | Автоинкремент ID |
| **TIMESTAMP WITH TIME ZONE** | Даты с учётом часового пояса |
| **Foreign Keys** | Связи между таблицами с каскадным удалением |
| **Indexes** | Ускорение поиска по email, date, status |
| **UNIQUE constraints** | Уникальность email, предотвращение дублей |
| **CHECK constraints** | Валидация на уровне БД (balance >= 0) |
| **ON DELETE CASCADE** | Автоудаление связанных записей |

### 4.5. Настройки подключения

```javascript
// server/src/infrastructure/database/config.cjs
module.exports = {
  development: {
    username: process.env.DB_USER || 'postgres',
    password: process.env.DB_PASSWORD || 'postgres',
    database: process.env.DB_NAME || 'school_canteen',
    host: process.env.DB_HOST || 'localhost',
    port: parseInt(process.env.DB_PORT) || 5432,
    dialect: 'postgres',
  }
}
```

---

## 5. Схема базы данных

### 5.1. ER-диаграмма (Entity-Relationship)

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              USERS & AUTH                                        │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  ┌──────────────────────┐           ┌──────────────────────┐                    │
│  │       users          │           │   refresh_tokens     │                    │
│  ├──────────────────────┤           ├──────────────────────┤                    │
│  │ PK id                │───────────│ FK user_id           │                    │
│  │    email (UNIQUE)    │     1:N   │ PK id                │                    │
│  │    password_hash     │           │    token             │                    │
│  │    full_name         │           │    expires_at        │                    │
│  │    role (ENUM)       │           └──────────────────────┘                    │
│  │    class_number      │                                                        │
│  │    class_letter      │           ┌──────────────────────┐                    │
│  │    balance (DECIMAL) │───────────│     allergies        │                    │
│  │    deleted_at        │     1:N   ├──────────────────────┤                    │
│  │    created_at        │           │ PK id                │                    │
│  │    updated_at        │           │ FK user_id           │                    │
│  └──────────────────────┘           │    allergen_name     │                    │
│           │                         └──────────────────────┘                    │
│           │                                                                      │
│           │                         ┌──────────────────────┐                    │
│           │ 1:N                     │  food_preferences    │                    │
│           ├─────────────────────────├──────────────────────┤                    │
│           │                         │ PK id                │                    │
│           │                         │ FK user_id           │                    │
│           │                         │    preference_name   │                    │
│           │                         └──────────────────────┘                    │
│           │                                                                      │
│  ┌────────┴─────────────┐     ┌──────────────────────┐                          │
│  │     payments         │     │    subscriptions     │                          │
│  ├──────────────────────┤     ├──────────────────────┤                          │
│  │ PK id                │     │ PK id                │                          │
│  │ FK user_id           │     │ FK user_id           │                          │
│  │    amount            │     │    type (ENUM)       │                          │
│  │    type (ENUM)       │     │    start_date        │                          │
│  │    status (ENUM)     │     │    end_date          │                          │
│  │    description       │     │    is_active         │                          │
│  │    created_at        │     └──────────────────────┘                          │
│  └──────────────────────┘                                                        │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│                              MENU & MEALS                                        │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  ┌──────────────────────┐           ┌──────────────────────┐                    │
│  │     menu_days        │───────────│     menu_items       │                    │
│  ├──────────────────────┤     1:N   ├──────────────────────┤                    │
│  │ PK id                │           │ PK id                │                    │
│  │    menu_date (UNIQUE)│           │ FK menu_day_id       │                    │
│  │    is_active         │           │    name              │                    │
│  │    created_at        │           │    description       │                    │
│  └──────────────────────┘           │    price (DECIMAL)   │                    │
│                                     │    calories          │                    │
│                                     │    meal_type (ENUM)  │◄──────┐            │
│                                     │    allergens         │       │            │
│                                     │    is_available      │       │            │
│                                     └──────────────────────┘       │            │
│                                              │                     │            │
│                                              │ 1:N                 │            │
│                                              │                     │            │
│  ┌──────────────────────┐           ┌────────┴─────────────┐       │            │
│  │       users          │───────────│    meal_pickups      │       │            │
│  │         (FK)         │     N:1   ├──────────────────────┤       │            │
│  └──────────────────────┘           │ PK id                │       │            │
│                                     │ FK user_id           │       │            │
│                                     │ FK menu_item_id      │───────┘            │
│                                     │    pickup_date       │                    │
│                                     │    meal_type (ENUM)  │                    │
│                                     │    paid_by (ENUM)    │                    │
│                                     │    is_received       │                    │
│                                     │    received_at       │                    │
│                                     └──────────────────────┘                    │
│                                                                                  │
│  ┌──────────────────────┐                                                        │
│  │       reviews        │                                                        │
│  ├──────────────────────┤                                                        │
│  │ PK id                │                                                        │
│  │ FK user_id           │                                                        │
│  │ FK menu_item_id      │                                                        │
│  │    rating (1-5)      │                                                        │
│  │    comment           │                                                        │
│  │    created_at        │                                                        │
│  └──────────────────────┘                                                        │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│                           INVENTORY & REQUESTS                                   │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  ┌──────────────────────┐           ┌──────────────────────┐                    │
│  │      products        │───────────│     inventory        │                    │
│  ├──────────────────────┤     1:N   ├──────────────────────┤                    │
│  │ PK id                │           │ PK id                │                    │
│  │    name (UNIQUE)     │           │ FK product_id        │                    │
│  │    unit              │           │    quantity_change   │                    │
│  │    quantity          │           │    reason            │                    │
│  │    min_quantity      │           │    created_at        │                    │
│  │    created_at        │           └──────────────────────┘                    │
│  └──────────────────────┘                                                       │
│           │                                                                      │
│           │ 1:N                     ┌──────────────────────┐                    │
│           ├─────────────────────────│menu_item_ingredients │                    │
│           │                         ├──────────────────────┤                    │
│           │                         │ PK id                │                    │
│           │                         │ FK menu_item_id      │◄── menu_items      │
│           │                         │ FK product_id        │                    │
│           │                         │    quantity          │ (на 1 порцию)      │
│           │                         └──────────────────────┘                    │
│           │                                                                      │
│  ┌────────┴─────────────┐                                                        │
│  │  purchase_requests   │                                                        │
│  ├──────────────────────┤                                                        │
│  │ PK id                │                                                        │
│  │ FK product_id        │                                                        │
│  │ FK created_by (user) │                                                        │
│  │ FK approved_by (user)│                                                        │
│  │    quantity          │                                                        │
│  │    comment           │                                                        │
│  │    status (ENUM)     │                                                        │
│  │    created_at        │                                                        │
│  │    updated_at        │                                                        │
│  └──────────────────────┘                                                        │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│                           TEMPLATES (Дополнительно)                              │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  ┌──────────────────────┐           ┌──────────────────────┐                    │
│  │   menu_templates     │───────────│ menu_template_items  │                    │
│  ├──────────────────────┤     1:N   ├──────────────────────┤                    │
│  │ PK id                │           │ PK id                │                    │
│  │    name              │           │ FK template_id       │                    │
│  │    description       │           │    name              │                    │
│  │    tags              │           │    price             │                    │
│  └──────────────────────┘           │    meal_type         │                    │
│           │                         │    allergens         │                    │
│           │                         └──────────────────────┘                    │
│           │ N:M                                                                  │
│           │                                                                      │
│  ┌────────┴─────────────┐           ┌──────────────────────┐                    │
│  │  template_groups     │───────────│template_group_items  │                    │
│  ├──────────────────────┤     1:N   ├──────────────────────┤                    │
│  │ PK id                │           │ PK id                │                    │
│  │    name              │           │ FK group_id          │                    │
│  │    description       │           │ FK template_id       │                    │
│  └──────────────────────┘           └──────────────────────┘                    │
│                                                                                  │
│  ┌──────────────────────┐           ┌──────────────────────┐                    │
│  │   week_templates     │───────────│ week_template_slots  │                    │
│  ├──────────────────────┤     1:N   ├──────────────────────┤                    │
│  │ PK id                │           │ PK id                │                    │
│  │    name              │           │ FK week_template_id  │                    │
│  │    description       │           │ FK template_id (опц) │                    │
│  └──────────────────────┘           │ FK group_id (опц)    │                    │
│                                     │    day_of_week       │                    │
│  ┌──────────────────────┐           └──────────────────────┘                    │
│  │   shuffle_usages     │                                                        │
│  ├──────────────────────┤                                                        │
│  │ PK id                │                                                        │
│  │ FK group_id          │                                                        │
│  │ FK template_id       │                                                        │
│  │    used_at           │                                                        │
│  └──────────────────────┘                                                        │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│                              NOTIFICATIONS                                       │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  ┌──────────────────────┐                                                        │
│  │    notifications     │                                                        │
│  ├──────────────────────┤                                                        │
│  │ PK id                │                                                        │
│  │ FK user_id           │                                                        │
│  │    title             │                                                        │
│  │    message           │                                                        │
│  │    is_read           │                                                        │
│  │    created_at        │                                                        │
│  └──────────────────────┘                                                        │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 5.2. Таблицы базы данных (DDL)

#### Основные таблицы

| Таблица | Описание | Записей (демо) |
|---------|----------|----------------|
| `users` | Пользователи (ученики, повара, админы) | 5 |
| `refresh_tokens` | JWT refresh токены | динамически |
| `allergies` | Аллергии пользователей | 2 |
| `food_preferences` | Пищевые предпочтения пользователей | динамически |
| `payments` | История платежей | 3 |
| `subscriptions` | Абонементы | 1 |
| `menu_days` | Дни меню | 5 |
| `menu_items` | Блюда в меню | ~15 |
| `meal_pickups` | Заказы питания | динамически |
| `reviews` | Отзывы о блюдах | динамически |
| `products` | Продукты на складе | 12 |
| `inventory` | История изменений склада | динамически |
| `menu_item_ingredients` | Рецептура (связь блюдо-продукт) | динамически |
| `purchase_requests` | Заявки на закупку | 3 |
| `notifications` | Уведомления | динамически |

#### Таблицы шаблонов (дополнительно)

| Таблица | Описание |
|---------|----------|
| `menu_templates` | Шаблоны дней меню |
| `menu_template_items` | Блюда в шаблонах |
| `template_groups` | Группы для shuffle |
| `template_group_items` | Связь группа-шаблон |
| `week_templates` | Недельные шаблоны |
| `week_template_slots` | Слоты (7 дней) |
| `shuffle_usages` | История использования |

### 5.3. ENUM типы

```sql
-- Роли пользователей
CREATE TYPE user_role AS ENUM ('student', 'cook', 'admin');

-- Типы питания
CREATE TYPE meal_type AS ENUM ('breakfast', 'lunch');

-- Типы платежей
CREATE TYPE payment_type AS ENUM ('single', 'subscription');

-- Статусы платежей
CREATE TYPE payment_status AS ENUM ('pending', 'completed', 'failed');

-- Статусы заявок
CREATE TYPE request_status AS ENUM ('pending', 'approved', 'rejected');

-- Типы подписок
CREATE TYPE subscription_type AS ENUM ('breakfast', 'lunch', 'full');

-- Способ оплаты заказа
CREATE TYPE paid_by_type AS ENUM ('balance', 'subscription');
```

### 5.4. Индексы

```sql
-- Пользователи
CREATE UNIQUE INDEX idx_users_email ON users(email);

-- Меню
CREATE UNIQUE INDEX idx_menu_days_date ON menu_days(date);
CREATE INDEX idx_menu_items_menu_day_id ON menu_items(menu_day_id);

-- Заказы
CREATE INDEX idx_meal_pickups_user_id ON meal_pickups(user_id);
CREATE INDEX idx_meal_pickups_pickup_date ON meal_pickups(pickup_date);

-- Платежи
CREATE INDEX idx_payments_user_id ON payments(user_id);
CREATE INDEX idx_payments_created_at ON payments(created_at);

-- Заявки
CREATE INDEX idx_purchase_requests_status ON purchase_requests(status);
CREATE INDEX idx_purchase_requests_created_by ON purchase_requests(created_by);

-- Уведомления
CREATE INDEX idx_notifications_user_id ON notifications(user_id);
CREATE INDEX idx_notifications_is_read ON notifications(is_read);

-- Токены
CREATE INDEX idx_refresh_tokens_user_id ON refresh_tokens(user_id);
CREATE INDEX idx_refresh_tokens_expires_at ON refresh_tokens(expires_at);

-- Предпочтения
CREATE UNIQUE INDEX unique_user_preference ON food_preferences(user_id, preference_name);

-- Заказы питания (предотвращение дублей)
CREATE UNIQUE INDEX unique_user_meal_per_day ON meal_pickups(user_id, pickup_date, meal_type);
```

---

## 6. Статистика проекта

### 6.1. Backend

| Компонент | Количество |
|-----------|------------|
| Модели Sequelize | 22 |
| Миграции | 24 |
| Сидеры | 6 |
| Контроллеры | 7 |
| Роуты | 7 |
| Валидаторы (Joi) | 7 |
| Сервисы | 8 |
| API эндпоинтов | 80+ |

### 6.2. Frontend

| Компонент | Количество |
|-----------|------------|
| Страницы | 20 |
| API модули | 7 |
| Layouts | 2 |
| Features | 1 (auth) |
| UI компоненты | 2 |

### 6.3. Безопасность

| Механизм | Реализация |
|----------|------------|
| JWT | httpOnly cookie для refresh токенов |
| Токены в БД | С ротацией и лимитом сессий (5) |
| Password hashing | bcrypt rounds = 12 (OWASP) |
| Rate limiting | 100/мин общий, 15/15мин login/register |
| CSRF | Double Submit Cookie |
| Headers | Helmet |
| Валидация | Joi на всех эндпоинтах |
| Race condition | SELECT FOR UPDATE (баланс, продукты) |
| Транзакции | Финансы, списание ингредиентов |
| Soft delete | Для пользователей |
| Рассылка уведомлений | Только для администраторов |

---

## 7. Тестовые пользователи

| Email | Пароль | Роль |
|-------|--------|------|
| <admin@school.ru> | password123 | Администратор |
| <cook@school.ru> | password123 | Повар |
| <student1@school.ru> | password123 | Ученик 9А |
| <student2@school.ru> | password123 | Ученик 10Б |
| <student3@school.ru> | password123 | Ученик 11В |

---

## 8. Ссылки

| Ресурс | Ссылка |
|--------|--------|
| **Репозиторий GitHub** | <https://github.com/y13sint/olymp> |
| **Видеоролик (RuTube)** | <https://rutube.ru/video/private/e5cf8df8bd6053212e6d7bf1a6061338/?p=gZJb-ObAcz5952qcP-qjOg> |

---
